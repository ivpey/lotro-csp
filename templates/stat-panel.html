<!DOCTYPE html>
<html lang="en" class="loading">
<head>
    <meta charset="UTF-8">
    {% with the_gear = char_sheet.itemSlots %}
        {% set gear_copy = {'itemSlots': the_gear.copy() } %}
        {% set cl_name = {'class': char_sheet.class_name, 'lvl': char_sheet.character_level | default(150, true)} %}
        <script>
            url_search = new URLSearchParams(window.location.search)
            ls = localStorage.getItem('gear-config');
            if (ls == null || url_search.has('hc') || url_search.has('item')) {
                document.getElementsByTagName('html')[0].classList.toggle('loading');
                localStorage.setItem('gear-config', '{{dict(gear_copy, **cl_name) | encode_gear_config}}');
            }
            else {
                const formData = new URLSearchParams();
                formData.append('load_stored', ls);

                fetch("{{ url_for('handle_choices') }}", {
                    method : 'POST',
                    headers: {
                        'Content-Type' : 'application/x-www-form-urlencoded'
                    },
                    body: formData.toString()
                }).then(
                    response => {
                        if (response.redirected) {
                            window.location = response.url
                        }
                    }
                )
            }
        </script>
    {% endwith %}
    <link rel="stylesheet" href="{{ url_for('static', filename='stat-panel.css') }}">
    <title>LOTRO Character Stats Panel</title>
</head>
<body>
    <div id="overlay-loading">
        <p>Loading gear config, please wait...</p>
        <div class="loader" id="state-5"></div>
        <div class="loader" id="state-4"></div>
        <div class="loader" id="state-3"></div>
        <div class="loader" id="state-2"></div>
        <div class="loader" id="state-1"></div>
    </div>
    <a href="{{ url_for('stats_panel_page') }}">
        <h1>LOTRO Character Stat Panel</h1>
    </a>
    <div class="inner">
        <div id="class-select" class="b1-parent-container">
            <div class="b1-tl"></div>
            <div class="b1-tm"></div>
            <div class="b1-tr"></div>
            <div class="b1-l"></div>
            <div class="b1-content">
                <form action="{{ url_for('handle_choices') }}" method = "POST">
                    <label for="char-level">
                        <img src="{{ url_for('static', filename = 'leveldeco.png') }}" alt="">
                    </label>
                    <input type="number" id="char-level" name="char-level" min = "1" max = "150" value = "{{char_sheet.character_level | default(150, true)}}">
                </form>
                <form action="{{ url_for('handle_choices') }}" method="POST">
                    {% for cl in char_sheet.class_list %}
                    <label>
                        <input type="radio" name="class-selection" value="{{ cl }}" onclick="this.parentElement.parentElement.submit()"
                        {% if char_sheet.class_name == cl %}
                            checked
                        {% endif %}
                        >
                        <img src="{{ url_for('static', filename = 'class-' + cl | lower + '.png') }}">
                    </label>
                    {% endfor %}
                </form>
            </div>
            <div class="b1-r"></div>
            <div class="b1-bl"></div>
            <div class="b1-bm"></div>
            <div class="b1-br"></div>
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                        <p id="notification">
                            {{ message }}
                        </p>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
    <div id="main" class="inner">
        {% set remove_stats_from_dropdown = ('In-Combat Morale Regeneration', 'Non-Combat Morale Regeneration', 'Maximum Power', 'In-Combat Power Regeneration', 'Non-Combat Power Regeneration') %}
        <div id="table-container" class="b1-parent-container">
            <div class="b1-tl"></div>
            <div class="b1-tm"></div>
            <div class="b1-tr"></div>
            <div class="b1-l"></div>
            <div class="b1-content">
                <div id="armor-jewelry-columns">
                    <table id="jewelry">
                        {% for item_slot in char_sheet.itemSlots.items() %}
                            {% if item_slot[1]['slot-type'] == 'jewelry' %}
                            <tr>
                                <td class="item" onclick="this.nextElementSibling.classList.toggle('noshow')">
                                    <div class="img-container">
                                        <div class="inside-img-container">
                                            <img
                                                {% if item_slot[1]['item-info']['icon-url'] %}                  
                                                    src="{{item_slot[1]['item-info']['icon-url']}}"
                                                {% else %}
                                                    src="{{ url_for('static', filename = item_slot[0] + '.png') }}"
                                                {% endif %}
                                            >
                                        </div>
                                    </div>
                                </td>
                                <td class="noshow b1-parent-container">
                                    <div class="b1-tl"></div>
                                    <div class="b1-tm"></div>
                                    <div class="b1-tr"></div>
                                    <div class="b1-l"></div>
                                    <form class="b1-content" method="POST" action= {{ url_for('load_items', item = item_slot[0]) }}>
                                        <div>
                                            <h2>Item name:</h2>
                                            <input
                                                name= "{{item_slot[0]}}"
                                                type="text"
                                                {% if item_slot[1]['item-info']['name'] %} value="{{ item_slot[1]['item-info']['name'] | format_url_unquote(True) }}" {% endif %}
                                            >
                                        </div>
                                        {% if item_slot[1]['item-info']['essences'] %}
                                            <h2>Essence slots:</h2>
                                            {% for essence in item_slot[1]['item-info']['essences'] %}
                                                <div>
                                                    <select name="essence_{{essence}}_stat">
                                                        <option value="0" {% if item_slot[1]['item-info']['essences'][essence]|length == 0 %} selected {% endif %} disabled>Essence {{ loop.index }}...</option>
                                                        {% for stat in stat_sheet.listAllStats() %}
                                                            {% if stat not in remove_stats_from_dropdown %}
                                                                <option value="{{stat}}" {{ 'selected' if stat in item_slot[1]['item-info']['essences'][essence] }}>{{stat}}</option>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </select>
                                                    <input type="number" name="essence_{{essence}}_value" value="{{ 0 if item_slot[1]['item-info']['essences'][essence].values()|length == 0 else item_slot[1]['item-info']['essences'][essence].values()|list|join }}">
                                                </div>
                                            {% endfor %}
                                        {% endif %}
                                        <div>
                                            <button type="submit">Update</button>
                                            <button onclick="document.getElementsByName('{{item_slot[0]}}')[0].value = ''; this.parentElement.submit()">Remove item</button>
                                        </div>
                                    </form>
                                    <div class="b1-r"></div>
                                    <div class="b1-bl"></div>
                                    <div class="b1-bm"></div>
                                    <div class="b1-br"></div>
                                </td>
                                {% if item_slot[1]['item-info']['name'] %}
                                <td class="tooltip">
                                    {{ item_slot[1]['item-info']['name'] | format_url_unquote | item_tooltip(item_slot[1]['item-info']['essences']) | safe }}
                                </td>
                                {% endif %}
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                    <table id="armor">
                        {% for item_slot in char_sheet.itemSlots.items() %}
                            {% if item_slot[1]['slot-type'] == 'armor' %}
                            <tr>
                                <td class="item" onclick="this.nextElementSibling.classList.toggle('noshow')">
                                    <div class="img-container">
                                        <div class="inside-img-container">
                                            <img
                                                {% if item_slot[1]['item-info']['icon-url'] %}                  
                                                    src="{{item_slot[1]['item-info']['icon-url']}}"
                                                {% else %}
                                                    src="{{ url_for('static', filename = item_slot[0] + '.png') }}"
                                                {% endif %}
                                            >
                                        </div>
                                    </div>
                                </td>
                                <td class="noshow b1-parent-container">
                                    <div class="b1-tl"></div>
                                    <div class="b1-tm"></div>
                                    <div class="b1-tr"></div>
                                    <div class="b1-l"></div>
                                    <form class="b1-content" method="POST" action= {{ url_for('load_items', item = item_slot[0]) }}>
                                        <div>
                                            <h2>Item name:</h2>
                                            <input
                                                name= "{{item_slot[0]}}"
                                                type="text"
                                                {% if item_slot[1]['item-info']['name'] %} value="{{ item_slot[1]['item-info']['name'] | format_url_unquote(True) }}" {% endif %}
                                            >
                                        </div>
                                        {% if item_slot[1]['item-info']['essences'] %}
                                            <h2>Essence slots:</h2>
                                            {% for essence in item_slot[1]['item-info']['essences'] %}
                                                <div>
                                                    <select name="essence_{{essence}}_stat">
                                                        <option value="" {% if item_slot[1]['item-info']['essences'][essence]|length == 0 %} selected {% endif %} disabled>Essence {{ loop.index }}...</option>
                                                        {% for stat in stat_sheet.listAllStats() %}
                                                            {% if stat not in remove_stats_from_dropdown %}
                                                                <option value="{{stat}}" {{ 'selected' if stat in item_slot[1]['item-info']['essences'][essence] }}>{{stat}}</option>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </select>
                                                    <input type="number" name="essence_{{essence}}_value" value="{{ 0 if item_slot[1]['item-info']['essences'][essence].values()|length == 0 else item_slot[1]['item-info']['essences'][essence].values()|list|join }}">
                                                </div>
                                            {% endfor %}
                                        {% endif %}
                                        <div>
                                            <button type="submit">Update</button>
                                            <button onclick="document.getElementsByName('{{item_slot[0]}}')[0].value = ''; this.parentElement.submit()">Remove item</button>
                                        </div>
                                    </form>
                                    <div class="b1-r"></div>
                                    <div class="b1-bl"></div>
                                    <div class="b1-bm"></div>
                                    <div class="b1-br"></div>
                                </td>
                                {% if item_slot[1]['item-info']['name'] %}
                                <td class="tooltip">
                                    {{ item_slot[1]['item-info']['name'] | format_url_unquote | item_tooltip(item_slot[1]['item-info']['essences']) | safe }}
                                </td>
                                {% endif %}
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                </div>
                <div>
                    <table id="weapons">
                        {% for item_slot in char_sheet.itemSlots.items() %}
                            {% if item_slot[1]['slot-type'] == 'weapon' %}
                            <tr>
                                <td class="item" onclick="this.nextElementSibling.classList.toggle('noshow')">
                                    <div class="img-container">
                                        <div class="inside-img-container">
                                            <img
                                                {% if item_slot[1]['item-info']['icon-url'] %}                  
                                                    src="{{item_slot[1]['item-info']['icon-url']}}"
                                                {% else %}
                                                    src="{{ url_for('static', filename = item_slot[0] + '.png') }}"
                                                {% endif %}
                                            >
                                        </div>
                                    </div>
                                </td>
                                <td class="noshow b1-parent-container">
                                    <div class="b1-tl"></div>
                                    <div class="b1-tm"></div>
                                    <div class="b1-tr"></div>
                                    <div class="b1-l"></div>
                                    <form class="b1-content" method="POST" action= {{ url_for('load_items', item = item_slot[0]) }}>
                                        <div>
                                            <h2>Item name:</h2>
                                            <input
                                                name= "{{item_slot[0]}}"
                                                type="text"
                                                {% if item_slot[1]['item-info']['name'] %} value="{{ item_slot[1]['item-info']['name'] | format_url_unquote(True) }}" {% endif %}
                                            >
                                        </div>
                                        {% if item_slot[1]['item-info']['essences'] %}
                                            <h2>Essence slots:</h2>
                                            {% for essence in item_slot[1]['item-info']['essences'] %}
                                                <div>
                                                    <select name="essence_{{essence}}_stat">
                                                        <option value="" {% if item_slot[1]['item-info']['essences'][essence]|length == 0 %} selected {% endif %} disabled>Essence {{ loop.index }}...</option>
                                                        {% for stat in stat_sheet.listAllStats() %}
                                                            {% if stat not in remove_stats_from_dropdown %}
                                                                <option value="{{stat}}" {{ 'selected' if stat in item_slot[1]['item-info']['essences'][essence] }}>{{stat}}</option>
                                                            {% endif %}
                                                        {% endfor %}
                                                    </select>
                                                    <input type="number" name="essence_{{essence}}_value" value="{{ 0 if item_slot[1]['item-info']['essences'][essence].values()|length == 0 else item_slot[1]['item-info']['essences'][essence].values()|list|join }}">
                                                </div>
                                            {% endfor %}
                                        {% endif %}
                                        <div>
                                            <button type="submit">Update</button>
                                            <button onclick="document.getElementsByName('{{item_slot[0]}}')[0].value = ''; this.parentElement.submit()">Remove item</button>
                                        </div>
                                    </form>
                                    <div class="b1-r"></div>
                                    <div class="b1-bl"></div>
                                    <div class="b1-bm"></div>
                                    <div class="b1-br"></div>
                                </td>
                                {% if item_slot[1]['item-info']['name'] %}
                                <td class="tooltip">
                                    {{ item_slot[1]['item-info']['name'] | format_url_unquote | item_tooltip(item_slot[1]['item-info']['essences']) | safe }}
                                </td>
                                {% endif %}
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </table>
                </div>
            </div>
            <div class="b1-r"></div>
            <div class="b1-bl"></div>
            <div class="b1-bm"></div>
            <div class="b1-br"></div>
        </div>
        <div id="stat-values" class="b1-parent-container">
            <div class="b1-tl"></div>
            <div class="b1-tm"></div>
            <div class="b1-tr"></div>
            <div class="b1-l"></div>
            <table class="b1-content">
                {% for stat in stat_sheet.listAllStats() %}
                    {% set curr = char_sheet.getTotalStat(stat, stat_sheet) %}
                    {% set prev = old_stats.getTotalStat(stat, stat_sheet) %}
                    {% set diff = 0 if old_stats.class_name != char_sheet.class_name else curr - prev %}
                    {% set color = ['', 'green', 'red'][0 if diff == 0 else (diff/(diff|abs))|int] %}
                    <tr>
                        <td>
                            {{ stat }}
                        </td>
                        <td >
                            <span>
                                {{ '{:0,.2f}'.format(curr) }}
                            </span>
                            {% if diff != 0 %}
                            <span class="{{ color }}">
                                ({{ '{:0,.2f}'.format(diff) }})
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </table>
            <div class="b1-r"></div>
            <div class="b1-bl"></div>
            <div class="b1-bm"></div>
            <div class="b1-br"></div>
        </div>
        <div id="side-buttons">
            <a href="#import-popup">
                <img src="{{ url_for('static', filename = 'upload.svg') }}" alt = "Import" title = "Import">
            </a>
            <a href="#export-popup">
                <img src="{{ url_for('static', filename = 'receipt.svg') }}" alt = "Export" title = "Export">
            </a>
            <form action = {{ url_for('handle_choices') }} method="POST" id="clear-gear">
                <input type="radio" name="clear-config" checked style="display: none; visibility: hidden; opacity: 0;">
                <button type="submit">
                    <img src="{{ url_for('static', filename = 'trash.svg') }}" alt = "Clear" title = "Clear">
                </button>
            </form>
            <a href="#settings-popup">
                <img src="{{ url_for('static', filename = 'settings.svg') }}" alt = "Settings" title = "Settings">
            </a>
        </div>
    </div>
    <div id="popups">
        <div id="import-popup" class = "overlay">
            <div class="popup">
                <h2>Import a gear config string</h2>
                <a class="close" href="#">&times;</a>
                <form action = {{ url_for('handle_choices') }} method="POST">
                    <!-- It is important that we do this as a form submission so the redirect can work -->
                    <input type="text" id="load_stored" name="load_stored">
                    <button type="submit" id="load" onclick="document.getElementsByTagName('html')[0].classList.toggle('loading')">Import</button>
                </form>
            </div>
        </div>
        <div id="export-popup" class = "overlay">
            <div class="popup">
                <h2>Export the current gear config string</h2>
                <a class="close" href="#">&times;</a>
                {% with the_gear = char_sheet.itemSlots %}
                    {% set gear_copy = {'itemSlots': the_gear.copy() } %}
                    {% set cl_name = {'class': char_sheet.class_name, 'lvl': char_sheet.character_level | default(150, true)} %}
                    <input type="text" value="{{dict(gear_copy, **cl_name) | encode_gear_config}}" onclick = "this.select()">
                {% endwith %}
            </div>
        </div>
        <div id="settings-popup" class = "overlay">
            <div class="popup">
                <h2>Settings</h2>
                <a class="close" href="#">&times;</a>
                <p>I am the settings pop-up. I will have a form here!</p>
                <form action = {{ url_for('handle_choices') }} method="POST" id="settings-form">
                    <fieldset>
                        <label for="setting-use-base">Take into account base stats from character level:</label>
                        <input type="checkbox" id="setting-use-base" name="setting-use-base"
                        {% if char_sheet.use_base_class_stats == True %}
                            checked
                        {% endif %}
                        >
                    </fieldset>
                    <fieldset>
                        <label for="setting-use-virtues">Include the active effects of the following virtues:</label>
                        <select name="setting-use-virtues" id="setting-use-virtues" multiple>
                            {% for virtue in ['Charity', 'Compassion', 'Confidence', 'Determination', 'Discipline', 'Empathy', 'Fidelity', 'Fortitude',
                                              'Honesty', 'Honour', 'Idealism', 'Innocence', 'Justice', 'Loyalty',	'Mercy', 'Patience', 'Tolerance',
                                              'Valour',	'Wisdom',	'Wit',	'Zeal'] %}
                                <option value="{{ virtue }}" {{ 'selected' if virtue in  char_sheet.use_virtues }}>{{ virtue }}</option>
                            {% endfor %}
                        </select>
                    </fieldset>
                    <button type="submit">Submit</button>
                </form>
            </div>
        </div>
    </div>
</body>
</html>